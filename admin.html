<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sensor Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    /* ... สไตล์ตามเดิม ... */
    :root {
      --bg: #f4f6f8;
      --card-bg: #fff;
      --text: #222;
      --subtext: #666;
      --shadow: rgba(0, 0, 0, 0.1);
      --btn-bg: #007bff;
      --btn-text: white;
    }
    body.dark {
      --bg: #1e1e1e;
      --card-bg: #2b2b2b;
      --text: #eaeaea;
      --subtext: #aaa;
      --shadow: rgba(255, 255, 255, 0.05);
      --btn-bg: #0d6efd;
      --btn-text: #fff;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      text-align: center;
      transition: background-color 0.3s, color 0.3s;
    }
    /* ... เพิ่มเติมตามเดิม ... */
  </style>
</head>
<body>
  <h1>🌐 Real-Time Sensor Dashboard & Control</h1>

  <button id="themeToggle">🌙 Dark Mode</button>
  
  <div id="userStatus" style="position: fixed; top: 20px; left: 20px; font-weight: bold;"></div>
  <div style="position: fixed; top: 50px; left: 30px; font-weight: bold;" id="timer">🕓login time: 0:00 minutes</div>

  <div class="value-cards">
    <div class="card">
      <div class="label">💧 Dissolved Oxygen (DO)</div>
      <div class="value" id="doValue">-- μg/L</div>
    </div>
    <div class="card">
      <div class="label">🌡️ Temperature</div>
      <div class="value" id="tempValue">-- °C</div>
    </div>
  </div>

  <div class="chart-container">
    <canvas id="doChart"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="tempChart"></canvas>
  </div>

  <div class="buttons">
    <button onclick="sendCommand('all')">Run All</button>
    <button onclick="sendCommand('wash')">Wash</button>
    <button onclick="sendCommand('wipe')">Wipe</button>
    <button onclick="sendCommand('reset')">Reset</button>
  </div>

  <div id="statusMsg">Idle</div>

<script>
  // config Firebase ของคุณ
  const firebaseConfig = {
    apiKey: "AIzaSyCahNGt0dOFJCmUw5MrmulZG1VsKIpt-F0",
    authDomain: "amutestv03.firebaseapp.com",
    databaseURL: "https://amutestv03-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "amutestv03",
    storageBucket: "amutestv03.firebasestorage.app",
    messagingSenderId: "879107687622",
    appId: "1:879107687622:web:ad0227a11bf8aa21ff43c7",
    measurementId: "G-37ETDELEFH"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  // เก็บสถานะ user
  let currentUser = null;

  auth.onAuthStateChanged(user => {
    if(user){
      currentUser = user;
      document.getElementById("userStatus").textContent = user.isAnonymous ? "👤 Guest Mode" : "👤 Admin Mode";
    } else {
      window.location.href = "login.html"; // เปลี่ยนถ้าคุณมีหน้าล็อกอิน
    }
  });

  // กราฟและข้อมูล
  const doLabels = [], doData = [], tempLabels = [], tempData = [];
  const doChart = new Chart(document.getElementById('doChart').getContext('2d'), {
    type: 'line',
    data: { labels: doLabels, datasets: [{ label: 'DO (μg/L)', data: doData, borderColor: 'red', tension: 0.3, fill: false, pointRadius: 0 }] },
    options: { animation: false, scales: { y: { min: 0, max: 12000 } } }
  });
  const tempChart = new Chart(document.getElementById('tempChart').getContext('2d'), {
    type: 'line',
    data: { labels: tempLabels, datasets: [{ label: 'Temperature (°C)', data: tempData, borderColor: 'blue', tension: 0.3, fill: false, pointRadius: 0 }] },
    options: { animation: false, scales: { y: { min: 0, max: 100 } } }
  });

  let updateInterval = 5000;
  let updateTimer = null;
  let stopTimer = null;
  let secondsPassed = 0;

  function updateData() {
    db.ref("sensor/do").once("value").then(snapshot => {
      const val = snapshot.val();
      if (val !== null) {
        document.getElementById("doValue").textContent = `${val} μg/L`;
        const now = new Date().toLocaleTimeString();
        doLabels.push(now); doData.push(val);
        if (doLabels.length > 20) { doLabels.shift(); doData.shift(); }
        doChart.update();
      }
    });
    db.ref("sensor/temp").once("value").then(snapshot => {
      const val = snapshot.val();
      if (val !== null) {
        document.getElementById("tempValue").textContent = `${val} °C`;
        const now = new Date().toLocaleTimeString();
        tempLabels.push(now); tempData.push(val);
        if (tempLabels.length > 20) { tempLabels.shift(); tempData.shift(); }
        tempChart.update();
      }
    });
  }

  function startUpdating() {
    if (!updateTimer) {
      updateData();
      updateTimer = setInterval(updateData, updateInterval);
    }
  }

  function stopUpdating() {
    if (updateTimer) {
      clearInterval(updateTimer);
      updateTimer = null;
    }
  }

  // ฟังก์ชันส่งคำสั่ง + บันทึก Activity Log
  function sendCommand(cmd) {
    if (!currentUser) {
      alert("Not logged in!");
      return;
    }
    // บันทึก Activity Log ลง Firebase
    const logRef = db.ref('activityLogs').push();
    logRef.set({
      userId: currentUser.uid,
      email: currentUser.email || "Guest",
      command: cmd,
      timestamp: Date.now()
    });

    // ส่งคำสั่ง
    db.ref("command").set(cmd)
      .then(() => {
        document.getElementById("statusMsg").textContent = "Working...";
        if (cmd === 'all') startUpdating();
        else stopUpdating();

        if (stopTimer) clearTimeout(stopTimer);
        stopTimer = setTimeout(() => {
          db.ref("command").set("idle").then(() => {
            document.getElementById("statusMsg").textContent = "Completed ✅";
            if (cmd === 'all') stopUpdating();
          });
        }, 360000); // 6 นาที
      })
      .catch(err => {
        document.getElementById("statusMsg").textContent = "Error!";
        console.error(err);
      });
  }

  // เวลา login
  function updateSessionTimer() {
    secondsPassed++;
    const m = Math.floor(secondsPassed / 60);
    const s = secondsPassed % 60;
    document.getElementById("timer").textContent = `🕓login time: ${m}:${s < 10 ? '0' : ''}${s} minutes`;
  }
  setInterval(updateSessionTimer, 1000);

  // ฟัง event คำสั่งเปลี่ยนสถานะ
  db.ref("command").on("value", snapshot => {
    const cmd = snapshot.val();
    const msg = {
      "all": "Running All...",
      "wash": "Washing...",
      "wipe": "Wiping...",
      "reset": "Resetting...",
      "idle": "Idle"
    };
    document.getElementById("statusMsg").textContent = msg[cmd] || "Unknown Command";
    if (cmd === "all") startUpdating(); else stopUpdating();
  });

  // Theme toggle
  document.getElementById("themeToggle").addEventListener("click", () => {
    document.body.classList.toggle("dark");
    const isDark = document.body.classList.contains("dark");
    document.getElementById("themeToggle").textContent = isDark ? "☀️ Light Mode" : "🌙 Dark Mode";
  });
</script>

</body>
</html>
