<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sensor Dashboard with Admin Log</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    /* (‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏∂‡∏á‡πÉ‡∏´‡πâ‡∏°‡∏≤) */
    :root {
      --bg: #f4f6f8;
      --card-bg: #fff;
      --text: #222;
      --subtext: #666;
      --shadow: rgba(0, 0, 0, 0.1);
      --btn-bg: #007bff;
      --btn-text: white;
    }
    body.dark {
      --bg: #1e1e1e;
      --card-bg: #2b2b2b;
      --text: #eaeaea;
      --subtext: #aaa;
      --shadow: rgba(255, 255, 255, 0.05);
      --btn-bg: #0d6efd;
      --btn-text: #fff;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      text-align: center;
      transition: background-color 0.3s, color 0.3s;
    }
    h1 {
      margin-bottom: 30px;
    }
    .value-cards {
      display: flex;
      justify-content: center;
      gap: 50px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    .card {
      background: var(--card-bg);
      padding: 20px 40px;
      border-radius: 15px;
      box-shadow: 0 4px 12px var(--shadow);
      min-width: 150px;
      flex: 1 1 150px;
      max-width: 250px;
    }
    .label {
      font-size: 1.2em;
      color: var(--subtext);
    }
    .value {
      font-size: 2.5em;
      margin-top: 10px;
      font-weight: bold;
    }
    .chart-container {
      width: 90vw;
      max-width: 900px;
      margin: 0 auto 40px;
    }
    canvas {
      width: 100% !important;
      height: 400px !important;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 2px 10px var(--shadow);
      padding: 10px;
    }
    .buttons {
      margin-bottom: 20px;
    }
    button {
      font-size: 1em;
      padding: 12px 25px;
      margin: 8px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background-color: var(--btn-bg);
      color: var(--btn-text);
      box-shadow: 0 4px 6px rgba(0, 123, 255, 0.4);
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    #statusMsg {
      font-size: 1.1em;
      margin-top: 15px;
      min-height: 1.5em;
      font-weight: 600;
    }
    #themeToggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: transparent;
      border: 2px solid var(--btn-bg);
      color: var(--btn-bg);
      border-radius: 25px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: bold;
      user-select: none;
    }
    #adminPanel {
      max-width: 900px;
      margin: 30px auto;
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 12px var(--shadow);
      color: var(--text);
      text-align: left;
    }
    #adminPanel h2 {
      margin-top: 0;
      margin-bottom: 15px;
    }
    #logTable {
      width: 100%;
      border-collapse: collapse;
    }
    #logTable th, #logTable td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 0.9em;
    }
    #logTable th {
      background-color: var(--btn-bg);
      color: var(--btn-text);
      position: sticky;
      top: 0;
    }
    #logBody {
      max-height: 300px;
      overflow-y: auto;
      display: block;
    }
    #logBody tr {
      display: table;
      width: 100%;
      table-layout: fixed;
    }
  </style>
</head>
<body>
  <h1>üåê Real-Time Sensor Dashboard & Control</h1>

  <button id="themeToggle">üåô Dark Mode</button>
  
  <div id="userStatus" style="position: fixed; top: 20px; left: 20px; font-weight: bold;"></div>
  
  <div style="position: fixed; top: 50px; left: 30px; font-weight: bold;" id="timer">
    üïìlogin time: 0:00 minutes
  </div>

  <div class="value-cards">
    <div class="card">
      <div class="label">üíß Dissolved Oxygen (DO)</div>
      <div class="value" id="doValue">-- Œºg/L</div>
    </div>
    <div class="card">
      <div class="label">üå°Ô∏è Temperature</div>
      <div class="value" id="tempValue">-- ¬∞C</div>
    </div>
  </div>

  <div class="chart-container">
    <canvas id="doChart"></canvas>
  </div>

  <div class="chart-container">
    <canvas id="tempChart"></canvas>
  </div>

  <div class="buttons">
    <button onclick="sendCommand('all')">Run All</button>
    <button onclick="sendCommand('wash')">Wash</button>
    <button onclick="sendCommand('wipe')">Wipe</button>
    <button onclick="sendCommand('reset')">Reset</button>
  </div>

  <div id="statusMsg">Idle</div>

  <!-- Admin Panel -->
  <div id="adminPanel" style="display:none;">
    <h2>üõ†Ô∏è Admin Activity Log</h2>
    <table id="logTable">
      <thead>
        <tr>
          <th>Time</th>
          <th>User</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="logBody"></tbody>
    </table>
  </div>

  <script>
    // Firebase config ‡∏Å‡∏π‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡∏°‡∏∂‡∏á‡πÄ‡∏î‡∏¥‡∏°
    const firebaseConfig = {
      apiKey: "AIzaSyCahNGt0dOFJCmUw5MrmulZG1VsKIpt-F0",
      authDomain: "amutestv03.firebaseapp.com",
      databaseURL: "https://amutestv03-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "amutestv03",
      storageBucket: "amutestv03.firebasestorage.app",
      messagingSenderId: "879107687622",
      appId: "1:879107687622:web:ad0227a11bf8aa21ff43c7",
      measurementId: "G-37ETDELEFH"
    };
    firebase.initializeApp(firebaseConfig);

    let currentUser = null;
    let isAdmin = false;

    firebase.auth().onAuthStateChanged((user) => {
      const userStatusEl = document.getElementById("userStatus");
      if (user) {
        currentUser = user;
        if (user.isAnonymous) {
          userStatusEl.textContent = "üë§ Guest Mode";
          isAdmin = false;
          document.getElementById("adminPanel").style.display = "none";
        } else {
          userStatusEl.textContent = `üë§ Logged in as ${user.email}`;
          isAdmin = user.email.includes("admin");
          document.getElementById("adminPanel").style.display = isAdmin ? "block" : "none";
          if(isAdmin) {
            listenActivityLog();
          }
        }
        startTimer();
      } else {
        currentUser = null;
        userStatusEl.textContent = "Please Login";
        isAdmin = false;
        document.getElementById("adminPanel").style.display = "none";
      }
    });

    // Login ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏î (Google popup)
    function signIn() {
      var provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider).catch(e => alert(e.message));
    }
    function signOut() {
      firebase.auth().signOut();
    }

    // Login Prompt (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡πÄ‡∏ß‡πá‡∏ö)
    if (!firebase.auth().currentUser) {
      signIn();
    }

    // Timer ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤ login
    let loginTime = 0;
    let timerInterval = null;
    function startTimer() {
      clearInterval(timerInterval);
      loginTime = 0;
      timerInterval = setInterval(() => {
        loginTime++;
        let minutes = Math.floor(loginTime / 60);
        let seconds = loginTime % 60;
        document.getElementById("timer").textContent = `üïì login time: ${minutes}:${seconds.toString().padStart(2,"0")} minutes`;
      }, 1000);
    }

    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Database
    const db = firebase.database();
    const doRef = db.ref("sensor/DO");
    const tempRef = db.ref("sensor/Temperature");

    const activityLogRef = db.ref("activityLog");

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
    let doChart = null;
    let tempChart = null;
    let doData = [];
    let tempData = [];
    let timestamps = [];

    // ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÉ‡∏ô ms)
    const fetchInterval = 2000;

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü
    function loadDataForCharts() {
      doRef.limitToLast(50).on("value", (snapshot) => {
        const val = snapshot.val() || {};
        doData = [];
        timestamps = [];
        Object.entries(val).forEach(([key, data]) => {
          timestamps.push(new Date(data.timestamp));
          doData.push(data.value);
        });
        updateChart(doChart, timestamps, doData, "Dissolved Oxygen (Œºg/L)");
        if(timestamps.length > 0) {
          document.getElementById("doValue").textContent = doData[doData.length-1].toFixed(2) + " Œºg/L";
        }
      });
      tempRef.limitToLast(50).on("value", (snapshot) => {
        const val = snapshot.val() || {};
        tempData = [];
        Object.entries(val).forEach(([key, data]) => {
          tempData.push(data.value);
        });
        updateChart(tempChart, timestamps, tempData, "Temperature (¬∞C)");
        if(tempData.length > 0) {
          document.getElementById("tempValue").textContent = tempData[tempData.length-1].toFixed(2) + " ¬∞C";
        }
      });
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
    function createCharts() {
      const ctxDO = document.getElementById("doChart").getContext("2d");
      doChart = new Chart(ctxDO, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: "Dissolved Oxygen",
            borderColor: "#007bff",
            backgroundColor: "#007bff33",
            data: [],
            fill: true,
            tension: 0.2,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          animation: false,
          scales: {
            x: {
              type: 'time',
              time: {
                tooltipFormat: 'dd MMM yyyy HH:mm:ss',
                unit: 'minute'
              }
            },
            y: {
              beginAtZero: true
            }
          }
        }
      });

      const ctxTemp = document.getElementById("tempChart").getContext("2d");
      tempChart = new Chart(ctxTemp, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: "Temperature",
            borderColor: "#f44336",
            backgroundColor: "#f4433633",
            data: [],
            fill: true,
            tension: 0.2,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          animation: false,
          scales: {
            x: {
              type: 'time',
              time: {
                tooltipFormat: 'dd MMM yyyy HH:mm:ss',
                unit: 'minute'
              }
            },
            y: {
              beginAtZero: false
            }
          }
        }
      });
    }

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü
    function updateChart(chart, labels, data, label) {
      chart.data.labels = labels;
      chart.data.datasets[0].data = data;
      chart.data.datasets[0].label = label;
      chart.update();
    }

    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    const statusMsg = document.getElementById("statusMsg");

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ ESP32 ‡∏ú‡πà‡∏≤‡∏ô Firebase
    function sendCommand(cmd) {
      if(!currentUser) {
        alert("Please login first");
        return;
      }
      statusMsg.textContent = "Working...";
      const cmdRef = db.ref("commands/current");
      const timestamp = new Date().toISOString();
      cmdRef.set({
        command: cmd,
        user: currentUser.email || "anonymous",
        timestamp: timestamp
      }).then(() => {
        logActivity(cmd);
      }).catch((e) => {
        alert("Send command error: " + e.message);
      });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Activity Log
    function logActivity(action) {
      if(!currentUser) return;
      const logEntry = {
        action: action,
        user: currentUser.email || "anonymous",
        timestamp: new Date().toISOString()
      };
      activityLogRef.push(logEntry);
    }

    // ‡∏ü‡∏±‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå Activity Log ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin
    function listenActivityLog() {
      const logBody = document.getElementById("logBody");
      activityLogRef.limitToLast(50).on("child_added", (snapshot) => {
        const data = snapshot.val();
        if(!data) return;
        const tr = document.createElement("tr");
        const time = new Date(data.timestamp).toLocaleString();
        tr.innerHTML = `
          <td>${time}</td>
          <td>${data.user}</td>
          <td>${data.action}</td>
        `;
        logBody.appendChild(tr);
        // scroll ‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î
        logBody.scrollTop = logBody.scrollHeight;
      });
    }

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ command change ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° + ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏£‡∏≤‡∏ü
    const commandRef = db.ref("commands/current");
    commandRef.on("value", (snapshot) => {
      const val = snapshot.val();
      if (!val) {
        statusMsg.textContent = "Idle";
        return;
      }
      if(val.command === "all") {
        statusMsg.textContent = "Working... Showing Graphs";
        createCharts();
        loadDataForCharts();
      } else if(val.command === "wash" || val.command === "wipe") {
        statusMsg.textContent = `Working... (${val.command})`;
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
        if(doChart) doChart.destroy();
        if(tempChart) tempChart.destroy();
        document.getElementById("doValue").textContent = "-- Œºg/L";
        document.getElementById("tempValue").textContent = "-- ¬∞C";
      } else if(val.command === "reset") {
        statusMsg.textContent = "Resetting...";
        if(doChart) doChart.destroy();
        if(tempChart) tempChart.destroy();
        document.getElementById("doValue").textContent = "-- Œºg/L";
        document.getElementById("tempValue").textContent = "-- ¬∞C";
      }
      // ‡∏£‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏ñ‡πâ‡∏≤ val.finished==true (‡∏™‡∏°‡∏°‡∏ï‡∏¥) ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 60 ‡∏ß‡∏¥ ‡∏Å‡∏π‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏£‡∏≠ Firebase update ‡πÄ‡∏≠‡∏á
      // ‡∏°‡∏∂‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ù‡∏±‡πà‡∏á ESP32 ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï finished:true
    });

    // Dark mode toggle
    const themeToggle = document.getElementById("themeToggle");
    themeToggle.onclick = () => {
      document.body.classList.toggle("dark");
      themeToggle.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
    };

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°
    (function(){
      createCharts();
    })();

  </script>
</body>
</html>
